{% extends 'base.html' %}
{% load static %}

{% block title %}CSV ì—…ë¡œë“œ | ë¬¸ì‹œí¬42{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/bulk_form.css' %}">
{% endblock %}

{% block content %}
<div class="container">
  <h1>ğŸ“‚ CSV ì—…ë¡œë“œ ì¼ê´„ ì˜ˆì¸¡</h1>

  <form method="POST" enctype="multipart/form-data">
    {% csrf_token %}
    <label>
      CSV íŒŒì¼ ì—…ë¡œë“œ:
      <input type="file" name="csv_file" accept=".csv" required>
    </label>
    {% if filename %}
      <span style="margin-left: 10px; color: #555;">ğŸ“„ {{ filename }}</span>
    {% endif %}
    <br><br>
    <button type="submit">ì˜ˆì¸¡í•˜ê¸°</button>
  </form>

  {% if results %}
   <!-- ì˜ˆì¸¡ ê²°ê³¼ íƒ€ì´í‹€ê³¼ ë²„íŠ¼ì„ ë‚˜ë€íˆ ë°°ì¹˜ -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin: 30px 0 16px 0;">
      <h2 style="margin: 0; font-size: 1.6rem;">
        ğŸ“Š ì˜ˆì¸¡ ê²°ê³¼
        {% if accuracy %}
          <span style="font-size: 0.8em; color: gray;">
            (ì •í™•ë„: {{ accuracy|floatformat:2 }}%)
          </span>
        {% endif %}
      </h2>
      <button id="download-btn" style="margin-left: auto;">íŒŒì¼ë¡œ ì €ì¥</button>
    </div>

    <!-- âœ… ë°ì´í„° ì „ë‹¬ìš© JSON ìŠ¤í¬ë¦½íŠ¸ -->
    <script id="risk-data" type="application/json">
      {{ results|safe }}
    </script>

    <!-- âœ… í…Œì´ë¸” -->
    <table border="1">
      <thead>
        <tr>
          <th>ë‚˜ì´</th>
          <th>ì„±ë³„</th>
          <th>ì¶œì„</th>
          <th>ë¶€ì • ì–¸ì–´</th>
          <th>ë³´í˜¸ì ê³µê²©ì„±</th>
          <th>ì‹ ì²´ ì ‘ì´‰ ë°˜ì‘</th>
          <th>í˜•ì œìë§¤ ìˆ˜</th>
          <th>ì†Œë“ ìˆ˜ì¤€</th>
          <th>ë³´í˜¸ì ì •ì„œ ìƒíƒœ</th>
          <th>ì˜ˆì¸¡ê²°ê³¼</th>
        </tr>
      </thead>
      <tbody>
        {% for row in results %}
          <tr {% if row.ì˜ˆì¸¡ê²°ê³¼ == "ê°€ì •í­ë ¥ ìœ„í—˜ì´ ìˆìŠµë‹ˆë‹¤" %} style="background-color: #ffe6ea;" {% endif %}>
            {% for value in row.values %}
              <td>{{ value }}</td>
            {% endfor %}
          </tr>
        {% endfor %}
      </tbody>
    </table>

    <!-- âœ… ìŠ¤í¬ë¦½íŠ¸ -->
    <script>
       document.addEventListener("DOMContentLoaded", function () {
        let rawData;
        try {
          rawData = JSON.parse(`{{ results_json|escapejs }}`);
        } catch (e) {
          alert("ğŸ“› ì˜ˆì¸¡ ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
          console.error(e);
          return;
        }

        function convertToCSV(data) {
          const headers = Object.keys(data[0]);
          const rows = data.map(row => headers.map(h => `"${row[h] ?? ''}"`).join(','));
          return [headers.join(','), ...rows].join('\n');
        }

        function downloadCSV(csvContent, filename) {
          const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url;
          link.download = filename;
          link.click();
          URL.revokeObjectURL(url);
        }

        function downloadRiskOnly() {
          const riskOnly = rawData.filter(row => row['ì˜ˆì¸¡ê²°ê³¼'] === 'ê°€ì •í­ë ¥ ìœ„í—˜ì´ ìˆìŠµë‹ˆë‹¤');
          if (riskOnly.length === 0) {
            alert("âš ï¸ ìœ„í—˜ ì•„ë™ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
            return;
          }
          const csv = convertToCSV(riskOnly);
          downloadCSV(csv, "ìœ„í—˜_ì•„ë™_ì˜ˆì¸¡ê²°ê³¼.csv");
        }

        document.getElementById("download-btn").addEventListener("click", downloadRiskOnly);
      });
    </script>
  {% endif %}
</div>
{% endblock %}
